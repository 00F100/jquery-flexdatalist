jQuery.fn.flexdatalist=function(e,t){"use strict";var i=function(e){e.each(function(){var e=$(this),t=e.data("flexdatalist");e.removeClass("flexdatalist-set").attr("type","text").val(t&&t.originalValue?t.originalValue:"").removeData("flexdatalist").next(".flexdatalist-alias, ul.flexdatalist-multiple").remove()})};if("string"==typeof e&&"reset"!==e){var a=$(this).data("flexdatalist");if("destroy"===e)i($(this));else if("value"===e){if("undefined"==typeof t)return this[0].fvalue.get();this[0].fvalue.set(t)}else if("add"===e){if("undefined"==typeof t)return this[0].debug("Missing value to add!");this[0].fvalue.add(t)}else if("toggle"===e){if("undefined"==typeof t)return this[0].debug("Missing value to toggle!");this[0].fvalue.toggle(t)}else if("remove"===e){if("undefined"==typeof t)return this[0].debug("Missing value to remove!");this[0].fvalue.remove(t)}else if(a&&"undefined"!=typeof a[e]){if("undefined"==typeof t)return a[e];a[e]=t,$(this).data("flexdatalist",a)}return this}"undefined"!=typeof this[0]&&"undefined"!=typeof this[0].fvalue&&i($(this));var r=$.extend({url:null,data:[],params:{},relatives:null,chainedRelatives:!1,cache:!0,cacheLifetime:60,minLength:2,groupBy:!1,selectionRequired:!1,focusFirstResult:!1,textProperty:null,valueProperty:null,visibleProperties:[],thumbProperty:"thumb",searchIn:["label"],searchContain:!1,searchEqual:!1,searchByWord:!1,searchDisabled:!1,searchDelay:200,normalizeString:null,multiple:!1,maxShownResults:100,removeOnBackspace:!0,noResultsText:'No results found for "{keyword}"',toggleSelected:!1,allowDuplicateValues:!1,requestType:"get",limitOfValues:0,valuesSeparator:",",debug:!0},e);return this.each(function(){var e=$(this),t=this,i=null,a=null,s=null,n=e.data("flexdatalist");n||(n=$.extend({},r,e.data(),{multiple:e.is("[multiple]"),originalValue:e.val(),_values:[]})),this.init=function(){this.prepare(),this.chained(),this.fvalue.set(e.attr("value")),a.on("focus",function(e){t.control.redoSearchFocus(e),t.control.showAllResults(e)}).on("focusin",function(){s&&s.addClass("focus")}).on("input keydown",function(e){9===t.keyNum(e)&&t.results.remove(),t.control.backSpaceKeyRemove(e)}).on("input keyup",function(e){t.control.keypressSearch(e),t.control.copyValue(e),t.control.backSpaceKeyRemove(e)}).on("focusout",function(){s&&s.removeClass("focus")}).on("blur",function(){}),window.onresize=function(){t.position()}},this.control={keypressSearch:function(e){var r=t.keyNum(e),s=a.val(),l=s.length;clearTimeout(i),0===l&&n.minLength>0||l<n.minLength?t.results.remove():(!r||13!==r&&(37>r||r>40))&&(i=setTimeout(function(){l>=n.minLength?t.search(function(e){t.results.show(e)}):t.results.remove()},n.searchDelay))},redoSearchFocus:function(t){var i=e.val();0===i.length&&this.keypressSearch(t)},copyValue:function(e){if(13!==t.keyNum(e)){var i=a.val();n.multiple||(n.selectionRequired?t.fvalue.clear():t.fvalue.set(i))}},backSpaceKeyRemove:function(e){if(n.removeOnBackspace){var i=a.val(),r=a.data("_remove");r?(r.find(".fdl-remove").click(),a.data("_remove",null)):0===i.length&&n.multiple&&8===t.keyNum(e)&&a.data("_remove",a.parents("li:eq(0)").prev())}},showAllResults:function(){var e=a.val();e=$.trim(e),""===e&&0===n.minLength&&t.data(function(e){t.results.show(e)})}},this.prepare=function(){a=this.alias(),n.multiple?s=this.multipleInput(a):a.insertAfter(e),a.attr("autofocus")&&a.focus()},this.alias=function(){var t=e.clone(!1).attr({list:null,name:e.attr("name")?e.attr("name")+"-flexdatalist":null,id:e.attr("id")?e.attr("id")+"-flexdatalist":null}).addClass("flexdatalist-alias").removeClass("flexdatalist");return e.addClass("flexdatalist flexdatalist-set").prop("type","hidden"),t},this.multipleInput=function(t){return s=$('<ul tabindex="1">').addClass("flexdatalist-multiple").css({"border-color":e.css("border-left-color"),"border-width":e.css("border-left-width"),"border-style":e.css("border-left-style"),"border-radius":e.css("border-top-left-radius"),"background-color":e.css("background-color")}).insertAfter(e).click(function(){$(this).find("input").focus()}),$('<li class="input-container">').addClass("flexdatalist-multiple-value").append(t).appendTo(s),s},this.chained=function(){if(n.relatives&&n.chainedRelatives){var i=function(i){n.relatives.each(function(){var r=t.isEmpty($(this).val()),n=t.isEmpty(e.val());i||!r&&n||t.fvalue.clear(),s?r&&s?s.addClass("disabled"):s.removeClass("disabled"):a.prop("disabled",r)})};n.relatives.on("change",function(){i()}),i(!0)}},this.fvalue={get:function(){var t=e.val();return n.multiple?this.toObj(t):this.toStr(t)},set:function(i,a){var r=this;a||this.clear(!0),t.isEmpty(i)||this._normalize(i,function(i){t.isEmpty(i)||($.isArray(i)?$.each(i,function(e,t){r.extract(t,!0)}):r.extract(i,!0),e.trigger("change:flexdatalist",[i,null,n]).trigger("change"))})},add:function(e){this.set(e,!0)},toggle:function(e){this.multiple.toggle(e)},remove:function(e){this.multiple.remove(e)},_normalize:function(e,i){if(this.isJSON()||this.isCSV())try{e=this.toObj(e)}catch(a){t.debug("Invalid JSON given")}if(this.isCSV()||"string"==typeof n.valueProperty){var r=n.searchIn,s=n.searchEqual;n.searchIn=n.valueProperty.split(","),n.searchEqual=!0,t.search(function(e){e.length>0&&i(e),n.searchIn=r,n.searchEqual=s},e)}else i(e)},extract:function(i,a){var r=this.text(i),s=this.value(i);e.val();if(!t.isEmpty(i)){if(!s)return t.debug("No value found");if(!r)return t.debug("No text found")}r&&n._values.push(r),n.multiple?this.multiple.add(s,r):this.single(s,r),a||e.trigger("change:flexdatalist",[s,r,n]).trigger("change")},single:function(t,i){i&&i!==a.val()&&a.val(i,!0),e.val(t,!0)},multiple:{add:function(e,t){var i=this,r=this.li(e,t);r.click(function(){i.toggle($(this))}).find(".fdl-remove").click(function(){i.remove($(this).parent())}),this.push(e),a.val("",!0),this.checkLimit()},push:function(i){var a=t.fvalue.get();i=t.fvalue.toObj(i),a.push(i),i=t.fvalue.toStr(a),e.val(i,!0)},toggle:function(i){if(n.toggleSelected){i=this.findLi(i);var a=i.index(),r=t.fvalue.get();if(i.hasClass("disabled")){var s=i.data("value");r.splice(a,0,s),i.removeClass("disabled")}else r.splice(a,1),i.addClass("disabled");r=t.fvalue.toStr(r),t.value=r,e.trigger("change:flexdatalist",[i.data("value"),i.data("text"),n]).trigger("change")}},remove:function(i){i=this.findLi(i);var a=t.fvalue.get(),r=i.index();a.splice(r,1),a=t.fvalue.toStr(a),e.val(a,!0).trigger("change:flexdatalist",[i.data("value"),i.data("text"),n]).trigger("change"),i.remove(),n._values.splice(r,1),t.fvalue.multiple.checkLimit()},removeAll:function(){s.find("li:not(.input-container)").remove(),e.val("",!0),n._values=[]},li:function(e,t){var i=s.find("li.input-container");return $("<li>").addClass("value"+(n.toggleSelected?" toggle":"")).append('<span class="text">'+t+"</span>").append('<span class="fdl-remove">&times;</span>').data({text:t,value:e}).insertBefore(i)},checkLimit:function(){var e=n.limitOfValues;if(e>0){var t=s.find("li.input-container"),i=n._values.length;e==i?t.hide():t.show()}},findLi:function(e){if("object"!=typeof e){var t=e;e=null,s.find("li:not(.input-container)").each(function(){var i=$(this);return i.data("value")===t?(e=i,!1):void 0})}return e}},value:function(e){var i=e;return t.isObject(e)&&(i=this.isJSON()?this.toStr(e):t.isDefined(e,n.valueProperty)?e[n.valueProperty]:t.isDefined(e,n.searchIn[0])?e[n.searchIn[0]]:null),i},text:function(e){var i=e;return t.isObject(e)&&(i=e[n.searchIn[0]],i=t.isDefined(e,n.textProperty)?e[n.textProperty]:this.placeholders.replace(e,n.textProperty,i)),$("<div>").html(i).text()},placeholders:{replace:function(e,i,a){if(t.isObject(e)&&"string"==typeof i){var r=this.parse(i);if(!t.isEmpty(e)&&r)return $.each(r,function(a,r){t.isDefined(e,r)&&(i=i.replace(a,e[r]))}),i}return a},parse:function(e){var t=e.match(/\{.+?\}/g);if(t){var i={};return t.map(function(e){i[e]=e.slice(1,-1)}),i}return!1}},clear:function(t){n.multiple&&this.multiple.removeAll();var i=e.val();e.val("",!0),""!==i&&e.trigger("change:flexdatalist",[null,null,n]).trigger("change"),t&&a.val("",!0),n._values=[]},toObj:function(e){return"object"!=typeof e&&(t.isEmpty(e)?e=[]:this.isCSV()?(e=e.toString().split(n.valuesSeparator),e=$.map(e,function(e){return $.trim(e)})):this.isJSON()&&(e=JSON.parse(e))),e},toStr:function(e){return"string"!=typeof e&&(t.isEmpty(e)?e="":this.isCSV()?e=e.join(n.valuesSeparator):this.isJSON()&&(e=JSON.stringify(e))),$.trim(e)},isJSON:function(){var e=n.valueProperty;return t.isObject(e)||"*"===e},isCSV:function(){return!this.isJSON()&&n.multiple}},this.data=function(i){e.trigger("before:flexdatalist.data"),this.url(function(a){t._data(function(r){r=r.concat(a),t.datalist(function(a){if(r=a.concat(r),!n.allowDuplicateValues)for(var s=n._values,l=0;l<r.length;l++){var o=r[l];s&&s.indexOf(t.fvalue.text(o))>-1&&delete r[l]}e.trigger("after:flexdatalist.data",[r]),i(r)})})})},this._data=function(e){if("string"==typeof n.data){var i=n.data,a=t.cache.read(i);if(a)return void e(a);t.remote({url:i,success:function(a){var r=t.extractRemoteData(a);n.data=r,e(n.data),t.cache.write(i,n.data,n.cacheLifetime)}})}else e(n.data)},this.datalist=function(t){var i=e.attr("list"),a=[];this.isEmpty(i)||$("#"+i).find("option").each(function(){var e=$(this),t=e.val(),i=e.text();a.push({label:i.length>0?i:t,value:t})}),t(a)},this.url=function(i){var r=a.val(),s=e.val(),l=r;if(t.isEmpty(n.url))return i([]);n.cache&&2!==n.cache&&(l=r.substring(0,n.minLength>0?n.minLength:1));var o={};"post"===n.requestType&&($.each(n,function(e,t){0!=e.indexOf("_")&&(o[e]=t)}),delete o.relatives),this.remote({url:n.url,data:$.extend(n.params,{keyword:r,contain:n.searchContain,selected:s,options:o}),success:function(e){var s=t.extractRemoteData(e),n=a.val();n.length>=r.length&&i(s)}})},this.remote=function(t){e.hasClass("flexdatalist-loading")||(e.addClass("flexdatalist-loading"),t=$.extend({type:t.requestType,dataType:"json",complete:function(){e.removeClass("flexdatalist-loading")}},t),$.ajax(t))},this.extractRemoteData=function(e){var t=e.results?e.results:e;return"string"==typeof t&&0===t.indexOf("[{")&&(t=JSON.parse(t)),t.options&&(n=$.extend({},n,t.options)),this.isObject(t)?t:[]},this.search=function(i,r){this.data(function(s){var l=[];if(n.searchDisabled)return i(s);t.isDefined(r)||(r=a.val()),e.trigger("before:flexdatalist.search",[r,s]),r=t.split(r);for(var o=0;o<s.length;o++){var u=t.matches(s[o],r);u&&l.push(u)}e.trigger("after:flexdatalist.search",[r,s,l]),i(l)})},this.matches=function(e,i){var a=$.extend({},e),r=[],s=n.searchIn;if(i.length>0)for(var l=0;l<s.length;l++){var o=s[l];if(this.isDefined(e,o)&&e[o]){for(var u=e[o].toString(),f=u,c=this.split(u),d=0;d<i.length;d++){var h=i[d];t.find(h,c)&&(r.push(h),f=t.highlight(h,f))}f!==u&&(a[o+"_highlight"]=this.highlight(f))}}return 0===r.length||n.searchByWord&&r.length<i.length-1?!1:a},this.highlight=function(e,t){return e=e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),t?t.replace(new RegExp(e,n.searchContain?"ig":"i"),"|:|$&|::|"):(e=e.split("|:|").join('<span class="highlight">'),e.split("|::|").join("</span>"))},this.find=function(e,i){for(var a=0;a<i.length;a++){var r=i[a];if(r=t.normalizeString(r),e=t.normalizeString(e),n.searchEqual)return r==e;if(n.searchContain?r.indexOf(e)>=0:0===r.indexOf(e))return!0}return!1},this.split=function(e){if("string"==typeof e&&(e=[$.trim(e)]),n.searchByWord)for(var t=0;t<e.length;t++){var i=$.trim(e[t]);if(i.indexOf(" ")>0){var a=i.split(" ");$.merge(e,a)}}return e},this.normalizeString=function(e){if("string"==typeof e){var t=n.normalizeString;return"function"==typeof t&&(e=t(e)),e.toUpperCase()}return e},this.results={show:function(i){var a=this;if(this.remove(!0),0===i.length)return void this.empty(n.noResultsText);var r=this.container();n.groupBy?(i=this.group(i),Object.keys(i).forEach(function(e){var s=i[e],l=n.groupBy,o=t.results.highlight(s[0],l,e);$("<li>").addClass("group").append($("<span>").addClass("group-name").html(o)).append($("<span>").addClass("group-item-count").text(" "+s.length)).appendTo(r);a.items(s,r)})):this.items(i,r);var s=r.find("li:not(.group)");s.on("click",function(){var i=$(this).data("item");i&&(t.fvalue.extract(i),a.remove(),e.trigger("select:flexdatalist",[i,n]))}).hover(function(){s.removeClass("active"),$(this).addClass("active")},function(){$(this).removeClass("active")}),n.focusFirstResult&&s.filter(":first").addClass("active")},empty:function(e){if(!t.isEmpty(e)){var i=this.container(),r=a.val();e=e.split("{keyword}").join(r),$("<li>").addClass("item no-results").append(e).appendTo(i)}},items:function(t,i){var a=n.maxShownResults;e.trigger("show:flexdatalist.results",[t]);for(var r=0;r<t.length&&!(a>0&&a===r);r++)this.item(t[r]).appendTo(i);e.trigger("shown:flexdatalist.results",[t])},item:function(e){for(var i=$("<li>").data("item",e).addClass("item"),a=n.visibleProperties,r=0;r<a.length;r++){var s=a[r];if((!n.groupBy||n.groupBy!==s)&&t.isDefined(e,s)){var l={};if("thumb"===s)l=$("<img>").addClass("item item-"+s).attr("src",e[s]);else{var o=t.results.highlight(e,s);l=$("<span>").addClass("item item-"+s).html(o+" ")}l.appendTo(i)}}return i},container:function(){var i=e;n.multiple&&(i=s);var r=$("ul.flexdatalist-results");return 0===r.length&&(r=$("<ul>").addClass("flexdatalist-results").appendTo("body").css({"border-color":i.css("border-left-color"),"border-width":"1px","border-bottom-left-radius":i.css("border-bottom-left-radius"),"border-bottom-right-radius":i.css("border-bottom-right-radius")}).data("target",a),t.position(a)),r},group:function(e){for(var i=[],a=n.groupBy,r=0;r<e.length;r++){var s=e[r];if(t.isDefined(s,a)){var l=s[a];t.isDefined(i,l)||(i[l]=[]),i[l].push(s)}}return i},highlight:function(e,i,a){return t.isDefined(e,i+"_highlight")?e[i+"_highlight"]:t.isDefined(e,i)?e[i]:a},remove:function(e){var t="ul.flexdatalist-results";e&&(t="ul.flexdatalist-results li"),$(t).remove()}},this.position=function(){var e=$("input:focus:eq(0)");0===e.length&&(e=a),n.multiple&&(e=e.parents(".flexdatalist-multiple:eq(0)")),$("ul.flexdatalist-results").css({width:e.outerWidth()+"px",top:e.offset().top+e.outerHeight()+"px",left:e.offset().left+"px"})},this.keyNum=function(e){return e.which||e.keyCode},this.isEmpty=function(e){return t.isDefined(e)?null===e?!0:e===!0?!1:0===this.length(e)?!0:""===$.trim(e):!0},this.isObject=function(e){return e&&"object"==typeof e},this.length=function(e){return this.isObject(e)?Object.keys(e).length:"number"==typeof e||"number"==typeof e.length?e.toString().length:0},this.isDefined=function(e,t){var i="undefined"!=typeof e;return i&&"undefined"!=typeof t?"undefined"!=typeof e[t]:i},this.cache={write:function(e,i,a){if(t.cache.isSupported()){var r={value:i,timestamp:t.unixtime(),lifetime:a?a:!1};return sessionStorage.setItem(e,JSON.stringify(r))}return null},read:function(e){if(t.cache.isSupported()){var i=sessionStorage.getItem(e);if(i){var a=JSON.parse(i);if(a.lifetime){var r=t.unixtime()-a.timestamp;return a.lifetime>r?a.value:(t.cache["delete"](e),null)}return a.value}return null}return null},"delete":function(e){return t.cache.isSupported()?sessionStorage.removeItem(e):null},isSupported:function(){if(!n.cache)return!1;try{return"sessionStorage"in window&&null!==window.sessionStorage}catch(e){return!1}}},this.unixtime=function(e){var t=new Date;return e&&(t=new Date(e)),Math.round(t.getTime()/1e3)},this.csvToArray=function(e,t){return 0===e.length?t:"string"==typeof e?e.split(n.valuesSeparator):e},this.debug=function(t,i){n.debug&&(i||(i={}),t="Flexdatalist: "+t,console.warn(t),console.log($.extend({inputName:e.attr("name"),options:n},i)),console.log("--- /flexdatalist ---"))},n.searchIn=this.csvToArray(n.searchIn),n.relatives=n.relatives&&$(n.relatives).length>0?$(n.relatives):null,n.textProperty=null===n.textProperty?n.searchIn[0]:n.textProperty,n.visibleProperties=this.csvToArray(n.visibleProperties,n.searchIn),e.data("flexdatalist",n),this.init()})},jQuery(function(e){var t=e(document);t.data("flexdatalist")||e(document).mouseup(function(t){var i=e(".flexdatalist-results"),a=i.data("target");a&&a.is(":focus")||i.is(t.target)||0!==i.has(t.target).length||i.remove()}).keydown(function(t){var i=e(".flexdatalist-results"),a=i.find("li"),r=a.filter(".active"),s=r.index(),n=a.length,l=t.which||t.keyCode;if(0!==n){if(27===l)return i.remove();if(13===l)t.preventDefault(),r.click();else if(40===l||38===l){t.preventDefault(),40===l?r=n>s&&r.nextAll(".item").first().length>0?r.removeClass("active").nextAll(".item").first().addClass("active"):a.removeClass("active").filter(".item:first").addClass("active"):38===l&&(r=s>0&&r.prevAll(".item").first().length>0?r.removeClass("active").prevAll(".item").first().addClass("active"):a.removeClass("active").filter(".item:last").addClass("active"));var o=(0===r.prev().length?r:r.prev()).position().top;i.animate({scrollTop:o+i.scrollTop()},100)}}}).data("flexdatalist",!0),jQuery("input.flexdatalist:not(.flexdatalist-set)").flexdatalist()});var _defaultValFunc=jQuery.fn.val;jQuery.fn.val=function(e,t){return!t&&$(this).hasClass("flexdatalist-set")&&"undefined"!=typeof e?($(this)[0].fvalue.set(e),this):_defaultValFunc.apply(this,arguments)};