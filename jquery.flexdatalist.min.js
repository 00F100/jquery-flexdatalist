!function(e){e.fn.flexdatalist=function(t){var a=e(document);return a.data("flexdatalist")||e(document).mouseup(function(t){var a=e(".flexdatalist-results");a.is(t.target)||0!==a.has(t.target).length||a.remove()}).keydown(function(t){var a=e(".flexdatalist-results"),i=a.find("li"),n=i.filter(".active"),r=n.index(),s=i.length,l=t.keyCode||t.which;if(0!==s)if(13===l)n.click();else if(40===l||38===l){var o=0;40===l?s>r&&n.nextAll(".item").first().length>0&&(n=n.removeClass("active").nextAll(".item").first().addClass("active"),o=(0===n.prev().length?n:n.prev()).position().top,a.animate({scrollTop:o+a.scrollTop()},100)):38===l&&r>0&&n.prevAll(".item").first().length>0&&(n=n.removeClass("active").prevAll(".item").first().addClass("active"),o=(0===n.prev().length?n:n.prev()).position().top,a.animate({scrollTop:o+a.scrollTop()},100)),t.preventDefault()}}).data("flexdatalist",!0),this.each(function(){var a=e(this),i={},n=a.attr("name");a.hasClass("flexdatalist")||(t=e.extend({url:null,data:[],cache:!0,searchContain:!0,minLength:3,dataAsValue:!1,mergeRemoteData:!1,groupBy:!1,selectionRequired:!1,selectFirstResult:!0,visibleProperties:["thumb","text","category","description"],searchProperties:["text"]},t,a.data()),a.init=function(){a.on("keyup",function(e){var i=e.keyCode||e.which;if(13!==i&&38!==i&&40!==i){var n=a.keyword();n.length>=t.minLength?a.search():(a.removeResults(),t.selectionRequired&&a.clearInput())}}).attr("autocomplete","off").addClass("flexdatalist").trigger("init.flexdatalist",[t]),t.selectionRequired&&!a.selected()&&a.clearInput()},a.search=function(){a.data(function(i){var n=[],r=a.keyword();t.mergeRemoteData&&(i=e["extends"](t.data,i));for(var s=t.groupBy,l=0;l<i.length;l++){var o=a.match(i[l],r);if(o)if(s){if("undefined"!=typeof o[s]){var u=o[s];"undefined"==typeof n[u]&&(n[u]=[]),n[u].push(o)}}else n.push(o)}a.showResults(n)})},a.match=function(e,i){for(var n=!1,r=0;r<t.searchProperties.length;r++){var s=t.searchProperties[r];if("undefined"!=typeof e[s]){var l=e[s];a.find(l,i)&&(e[s+"_highlight"]=a.highlight(l,i),n=!0)}}return n?e:null},a.highlight=function(e,t){return e.replace(new RegExp(t,"ig"),'<span class="highlight">$&</span>')},a.find=function(e,i){return e=a.normalizeString(e),i=a.normalizeString(i),t.searchContain?e.indexOf(i)>=0:0===e.indexOf(i)},a.data=function(i){if(t.data.length>0)return void i(t.data);var n=a.attr("list");if(n)return e("#"+n).find("option").each(function(){t.data.push({text:e(this).text(),value:e(this).val()})}),void i(t.data);var r=a.keyword(),s=r.substring(0,t.minLength),l=a.cache(s);return l?void i(l):void(a.hasClass("flexdatalist-loading")||(a.addClass("flexdatalist-loading"),e.ajax({url:t.url,data:{keyword:r,contain:t.searchContain},type:"post",dataType:"json",success:function(e){a.removeClass("flexdatalist-loading");var t=e.results?e.results:e;"string"==typeof t&&0===t.indexOf("[{")&&(t=JSON.parse(t)),"object"==typeof t&&(i(t),a.cache(s,t))}})))},a.cache=function(e,n){if(t.cache){if(e=a.normalizeString(e),"undefined"==typeof n)return"undefined"!=typeof i[e]&&(n=i[e]),n;i[e]=n}return null},a.showResults=function(i){if(a.removeResults(),0!==i.length||0!==Object.keys(i).length){var n=a.getContainer();t.selectionRequired&&a.clearInput(),t.groupBy?Object.keys(i).forEach(function(t){var r=i[t];e("<li>").addClass("group").append(e("<span>").addClass("group-name").text(t)).append(e("<span>").addClass("group-item-count").text(" "+r.length)).appendTo(n);a.items(r,n)}):a.items(i,n);var r=n.find("li:not(.group)");r.on("click",function(){var t=e(this).data("item");a.setValue(t).trigger("select.flexdatalist",[e(this)]),a.removeResults()}).hover(function(){r.removeClass("active"),e(this).addClass("active")},function(){e(this).removeClass("active")}),t.selectFirstResult&&r.filter(":first").addClass("active"),a.position(n)}},a.getContainer=function(){var t=e("ul.flexdatalist-results");return 0===t.length&&(t=e("<ul>").addClass("flexdatalist-results").appendTo("body").css("border-color",a.css("border-left-color"))),t},a.removeResults=function(){return e("ul.flexdatalist-results").remove(),a},a.items=function(e,t){for(var i=0;i<e.length;i++)a.setItem(e[i]).appendTo(t)},a.setItem=function(a){for(var i=e("<li>").data("item",a).addClass("item"),n=0;n<t.visibleProperties.length;n++){var r=t.visibleProperties[n];if((!t.groupBy||t.groupBy!==r)&&"undefined"!=typeof a[r])if("thumb"===r)e("<img>").addClass("item-"+r).attr("src",a[r]).appendTo(i);else{var s=a[r];"undefined"!=typeof a[r+"_highlight"]&&(s=a[r+"_highlight"]),e("<span>").addClass("item-"+r).html(s+" ").appendTo(i)}}return i},a.position=function(e){e.css({width:a.outerWidth()+"px",top:a.offset().top+a.outerHeight()+"px",left:a.offset().left+"px"})},a.setValue=function(e){var i=e.value?e.value:e.text;return i=i.trim(),a.val(i),t.dataAsValue&&(delete e.highlight,i=JSON.stringify(e)),a.getInput().val(i)},a.getInput=function(){if(!t.selectionRequired&&!t.dataAsValue)return a;var i=e('input[type="hidden"][name="'+n+'"]');return i.length>0?i:(a.attr("name",null),e('<input type="hidden">').attr({name:n}).insertAfter(a))},a.clearInput=function(){a.getInput().val("")},a.normalizeString=function(e){return e.toUpperCase()},a.selected=function(){return a.getInput().val().trim().length>0},a.keyword=function(){return this.val().trim()},a.init())})}}(jQuery);