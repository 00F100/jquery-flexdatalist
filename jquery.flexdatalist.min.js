!function(e){"use strict";e.fn.flexdatalist=function(t,i){var a=e(document),s=e(this),n=this;if(this._destroy=function(){s.each(function(){var t=e(this).data("flexdatalist");e(this).removeClass("flexdatalist-set").off().attr("type","text").val(t.originalValue).data("flexdatalist",null).next(".flexdatalist-alias, ul.flexdatalist-multiple").remove()})},this._reset=function(){this._destroy()},"string"==typeof t)if("function"==typeof this["_"+t]){if(!this["_"+t]())return this}else if(i){var r=s.data("flexdatalist");return r[t]=i,s.data("flexdatalist",r),this}return this._keyNum=function(e){return e.which||e.keyCode},a.data("flexdatalist")||e(document).mouseup(function(t){var i=e(".flexdatalist-results"),a=i.data("target");a&&a.is(":focus")||i.is(t.target)||0!==i.has(t.target).length||i.remove()}).keydown(function(t){var i=e(".flexdatalist-results"),a=i.find("li"),s=a.filter(".active"),r=s.index(),l=a.length,o=n._keyNum(t);if(0!==l)if(13===o)t.preventDefault(),s.click();else if(40===o||38===o){t.preventDefault(),40===o?s=l>r&&s.nextAll(".item").first().length>0?s.removeClass("active").nextAll(".item").first().addClass("active"):a.removeClass("active").filter(".item:first").addClass("active"):38===o&&(s=r>0&&s.prevAll(".item").first().length>0?s.removeClass("active").prevAll(".item").first().addClass("active"):a.removeClass("active").filter(".item:last").addClass("active"));var u=(0===s.prev().length?s:s.prev()).position().top;i.animate({scrollTop:u+i.scrollTop()},100)}}).data("flexdatalist",!0),this._isEmpty=function(t){return n._isDefined(t)?null===t?!0:t===!0?!1:0===this._length(t)?!0:""===e.trim(t):!0},this._isObject=function(e){return e&&"object"==typeof e},this._length=function(e){return this._isObject(e)?Object.keys(e).length:"number"==typeof e.length?e.length:0},this._isDefined=function(e,t){var i="undefined"!=typeof e;return i&&"undefined"!=typeof t?"undefined"!=typeof e[t]:i},this.each(function(){var i=e(this),a={},s="",r=null;i.attr("name");if(!i.hasClass("flexdatalist-set")){i._options=function(t,a){var s=i.data("flexdatalist");if(!n._isDefined(t))return i.data("flexdatalist");if(n._isDefined(a))s[t]=a;else{if(!n._isObject(t))return n._isDefined(s,t)?s[t]:null;s=t}return s.searchIn="string"==typeof s.searchIn?s.searchIn.split(","):s.searchIn,s.relatives=s.relatives&&e(s.relatives).length>0?e(s.relatives):null,s.textProperty=null===s.textProperty?s.searchIn[0]:s.textProperty,s.visibleProperties=0===s.visibleProperties.length?s.searchIn[0]:s.visibleProperties,i.data("flexdatalist",s),i},i._options(e.extend({url:null,data:[],params:{},relatives:null,chainedRelatives:!1,cache:!0,minLength:2,groupBy:!1,selectionRequired:!1,focusFirstResult:!1,textProperty:null,valueProperty:null,visibleProperties:[],searchIn:["label"],searchContain:!1,searchEqual:!1,normalizeString:null,multiple:i.attr("multiple"),maxShownResults:100,toggleSelected:!1,_values:[]},t,i.data()));var l=i.clone(!1).attr({list:null,name:null}).addClass("flexdatalist-alias").removeClass("flexdatalist");if(i._options("multiple")){var o=e("<ul>").addClass("flexdatalist-multiple").css({"background-color":i.css("background-color"),"border-color":i.css("border-left-color"),"border-width":i.css("border-left-width"),"border-style":i.css("border-left-style"),"border-radius":i.css("border-top-left-radius")}).insertAfter(i).click(function(){e(this).find("input").focus()});e('<li class="input-container">').addClass("flexdatalist-multiple-value").append(l).appendTo(o)}else l.insertAfter(i);i.addClass("flexdatalist").attr("type","hidden"),i._init=function(){var e=i._options();l.on("input keydown",function(t){var a=i._keyword();188===n._keyNum(t)&&!e.selectionRequired&&e.multiple&&(t.preventDefault(),i._value(a),i._removeResults())}).on("input keyup",function(t){if(i._changed()&&13!==n._keyNum(t)){var a=i._keyword();a.length>=e.minLength?i._search(function(e){i._showResults(e)}):i._removeResults(),e.multiple||(e.selectionRequired?0!==a.length&&i._selected()||i._value(""):i._value(a))}s=i._keyword()}).focus(function(){0===e.minLength&&(""===i._keyword()?i._tdata(function(e){i._showResults(e)}):l.trigger("keyup"))}).blur(function(){e.selectionRequired&&!i._selected()&&i._value("")}).attr("autocomplete","off"),i.addClass("flexdatalist-set"),window.onresize=function(){i._position()},l.attr("autofocus")&&l.focus()},i._changed=function(){return s!==i._keyword()},i._chained=function(){var t=i._options();if(t.relatives&&t.chainedRelatives){var s=function(a){t.relatives.each(function(){var s=n._isEmpty(e(this).val()),r=n._isEmpty(i.val());l.prop("disabled",s),a||!s&&r||(i._value(""),l.val(""),t.multiple&&o.find("li .remove").click())})};t.relatives.on("change",function(){s(),a={}}),s(!0)}},i._initValue=function(){var e=i.attr("value");n._isEmpty(e)||(i._options("originalValue",i.val()),i.val(""),l.val(""),i._parseValue(e,function(e){n._isEmpty(e)||i._values(e),s=i._keyword()}))},i._parseValue=function(e,t){var a=i._options();if(i._toJSON())try{t(JSON.parse(e))}catch(s){}else if(i._toCSV()||"string"==typeof a.valueProperty){var n=e.split(",");if("string"==typeof a.valueProperty){var r=a.searchIn;a.searchIn=a.valueProperty.split(","),a.searchEqual=!0,i._search(function(e){e.length>0&&t(e),a.searchIn=r,a.searchEqual=!1},n)}else t(n)}else t(e)},i._tdata=function(e){i.hasClass("flexdatalist-loading")||(clearTimeout(r),r=setTimeout(function(){i._url(function(t){i._data(function(i){e(i.concat(t))})})},200))},i._data=function(e){var t=i._options(),a=i._keyword();t.minLength>0&&t.minLength>a.length||("string"==typeof t.data?i._remote({url:t.data,success:function(a){var s=i._remoteData(a);t.data=s,e(s)}}):e(t.data))},i._url=function(t){var a=i._options(),s=i._keyword(),r=s;if(n._isEmpty(a.url)||a.minLength>s.length)return t([]);a.cache&&2!==a.cache&&(r=s.substring(0,a.minLength>0?a.minLength:1));var l=i._cache(r);return l?void t(l):void i._remote({url:a.url,data:e.extend(i._relativesData(),a.params,{keyword:s,contain:a.searchContain,selected:i.val()}),success:function(e){i.removeClass("flexdatalist-loading");var a=i._remoteData(e),n=i._keyword();n.length>s.length?i._search(function(e){i._showResults(e)}):t(a),i._cache(r,a)}})},i._remote=function(t){i.addClass("flexdatalist-loading"),t=e.extend({type:"post",dataType:"json",complete:function(){i.removeClass("flexdatalist-loading")}},t),e.ajax(t)},i._remoteData=function(e){var t=e.results?e.results:e;return"string"==typeof t&&0===t.indexOf("[{")&&(t=JSON.parse(t)),n._isObject(t)?t:[]},i._relativesData=function(){var t=i._options("relatives"),a={};return t&&(a.relatives={},t.each(function(){var t=e(this);a.relatives[t.attr("name")]=t.val()})),a},i._datalist=function(){var t=i._options(),a=i.attr("list");return n._isEmpty(a)||(t.data=[],e("#"+a).find("option").each(function(){var i=e(this).val();t.data.push({label:i,value:i})})),i},i._cache=function(e,t){if(i._options("cache")){if(e=i._normalizeString(e),!n._isDefined(t))return n._isDefined(a,e)&&(t=a[e]),t;a[e]=t}return null},i._search=function(e,t){i._tdata(function(a){var s=[],r=i._options("_values");n._isDefined(t)||(t=i._keyword()),"string"==typeof t&&(t=[t]);for(var l=0;l<t.length;l++)for(var o=t[l],u=0;u<a.length;u++){var c=i._matches(a[u],o,r);c&&s.push(c)}e(s)})},i._matches=function(e,t,a){var s=!1,r=i._options(),l=r.searchIn,o=r.visibleProperties;if(a&&a.indexOf(i._getText(e))>-1)return!1;for(var u=0;u<l.length;u++){var c=l[u],d=o[u];if(n._isDefined(e,c)&&n._isDefined(e,d)){var f=e[c].toString(),_=e[d];i._find(t,f)&&(e[d+"_highlight"]=i._highlight(t,_.toString()),s=!0)}}return s?e:null},i._highlight=function(e,t){return t.replace(new RegExp(e,i._options("searchContain")?"ig":"i"),'<span class="highlight">$&</span>')},i._find=function(e,t){var a=i._options();return t=i._normalizeString(t),e=i._normalizeString(e),a.searchEqual?t==e:a.searchContain?t.indexOf(e)>=0:0===t.indexOf(e)},i._showResults=function(t){i._removeResults();var a=i._getResultsContainer(),s=i._options();if(i._selected()&&i._selected(!1)._value(""),0!==t.length){s.groupBy?(t=i._groupData(t),Object.keys(t).forEach(function(n){var r=t[n],l=s.groupBy,o=i._getHighlight(r[0],l,n);e("<li>").addClass("group").append(e("<span>").addClass("group-name").html(o)).append(e("<span>").addClass("group-item-count").text(" "+r.length)).appendTo(a);i._items(r,a)})):i._items(t,a);var n=a.find("li:not(.group)");n.on("click",function(){var t=e(this).data("item");t&&(i._selected(!0)._removeResults()._value(t),i.trigger("select:flexdatalist",[t,s]))}).hover(function(){n.removeClass("active"),e(this).addClass("active")},function(){e(this).removeClass("active")}),s.focusFirstResult&&n.filter(":first").addClass("active"),i._position()}},i._groupData=function(e){for(var t=[],a=i._options("groupBy"),s=0;s<e.length;s++){var r=e[s];if(n._isDefined(r,a)){var l=r[a];n._isDefined(t,l)||(t[l]=[]),t[l].push(r)}}return t},i._getResultsContainer=function(){var t=i;i._options("multiple")&&(t=o);var a=e("ul.flexdatalist-results");return 0===a.length&&(a=e("<ul>").addClass("flexdatalist-results").appendTo("body").css({"border-color":t.css("border-left-color"),"border-width":"1px","border-bottom-left-radius":t.css("border-bottom-left-radius"),"border-bottom-right-radius":t.css("border-bottom-right-radius")}).data("target",l)),a},i._items=function(e,t){for(var a=i._options("maxShownResults"),s=0;s<e.length&&!(a>0&&a===s);s++)i._item(e[s]).appendTo(t)},i._item=function(t){for(var a=e("<li>").data("item",t).addClass("item"),s=i._options(),r=s.visibleProperties,l=0;l<r.length;l++){var o=r[l];if((!s.groupBy||s.groupBy!==o)&&n._isDefined(t,o)){var u={};if("thumb"===o)u=e("<img>").addClass("item item-"+o).attr("src",t[o]);else{var c=i._getHighlight(t,o);u=e("<span>").addClass("item item-"+o).html(c+" ")}u.appendTo(a)}}return a},i._removeResults=function(){return e("ul.flexdatalist-results").remove(),i},i._selected=function(e){var t="flexdatalist-selected";return n._isDefined(e)?(e?i.addClass(t):i.removeClass(t),i):i.hasClass(t)},i._values=function(t){return e.isArray(t)&&!n._isEmpty(t)?void e.each(t,function(e,t){i._value(t)}):void i._value(t)},i._value=function(t){var a=i._options(),n=i._getText(t),r=i._getValue(t);if(n.length>0&&a._values.push(n),a.multiple){if(""===t)return i;l.val("");var u=e("<li>").addClass("value"+(a.toggleSelected?" toggle":"")).append('<span class="text">'+n+"</span>").append('<span class="fdl-remove">&times;</span>').insertBefore(o.find("li.input-container"));u.find("span.fdl-remove").click(function(){var t=e(this).parent(),s=t.index();if(!t.hasClass("disabled")&&(i._toJSON()||i._toCSV())){var n=i._inputValue();n.splice(s,1),a._values.splice(s,1),i._inputValue(n)}t.remove()}),a.toggleSelected&&u.click(function(){var t=e(this),s=i._inputValue(),n=t.index();if(t.hasClass("disabled")){var r=t.data("_value");s.splice(n,0,r),a._values.splice(n,0,i._getText(r)),t.removeClass("disabled")}else{var r=s.splice(n,1);t.data("_value",r[0]),a._values.splice(n,1),t.addClass("disabled")}i._inputValue(s)})}else n&&n!==l.val()&&l.val(n);return i._inputValue(r,n),s=i._keyword(),i},i._inputValue=function(e,t){var a=i._toJSON(),s=i._toCSV();return n._isDefined(e)?(n._isObject(e)&&(a&&!n._isEmpty(e)?e=JSON.stringify(e):s&&(e=e.join(","))),i.val(e),i.trigger("change:flexdatalist",[e,t,i._options()]).trigger("change"),e):(e=i.val(),e?a?e=JSON.parse(e):s&&(e=e.split(",")):(a||s)&&(e=[]),e)},i._getText=function(t){var a=t,s=i._options();return n._isObject(t)&&(a=t[s.searchIn[0]],a=n._isDefined(t,s.textProperty)?t[s.textProperty]:i._replacePlaceholders(t,s.textProperty,a)),e("<div>").html(a).text()},i._getValue=function(t){var a=t,s=i._options();if(n._isObject(t))if(a=t[s.searchIn[0]],"*"===s.valueProperty)a=t;else if(n._isDefined(t,s.valueProperty))a=t[s.valueProperty];else if(i._toJSON()){var a={},r=s.valueProperty,l=s.textProperty;if(l){var o=l;"string"==typeof l&&(o=i._parsePlaceholders(l)),n._isObject(o)&&e.each(o,function(e,t){r.push(t)})}else n._isDefined(t,l)&&r.push(l);e.each(r,function(e,i){n._isDefined(t,i)&&(a[i]=t[i])})}if(s.multiple&&(i._toJSON()||i._toCSV())){var u=i._inputValue();!n._isEmpty(a)&&n._isObject(u)&&(u.push(a),a=u)}return a},i._replacePlaceholders=function(t,a,s){if(n._isObject(t)&&"string"==typeof a){var r=i._parsePlaceholders(a);if(!n._isEmpty(t)&&r)return e.each(r,function(e,i){n._isDefined(t,i)&&(a=a.replace(e,t[i]))}),a}return s},i._parsePlaceholders=function(e){var t=e.match(/\{.+?\}/g);if(t){var i={};return t.map(function(e){i[e]=e.slice(1,-1)}),i}return!1},i._normalizeString=function(e){if("string"==typeof e){var t=i._options("normalizeString");return"function"==typeof t&&(e=t(e)),e.toUpperCase()}return e},i._keyword=function(){return l.val().replace(/^\s+/,"")},i._toJSON=function(){var e=i._options("valueProperty");return n._isObject(e)||"*"===e},i._toCSV=function(){return!i._toJSON()&&i._options("multiple")},i._getHighlight=function(e,t,i){return n._isDefined(e,t+"_highlight")?e[t+"_highlight"]:n._isDefined(e,t)?e[t]:i},i._position=function(){var t=l;i._options("multiple")&&(t=o),e("ul.flexdatalist-results").css({width:t.outerWidth()+"px",top:t.offset().top+t.outerHeight()+"px",left:t.offset().left+"px","z-index":t.css("z-index")+1})},i._datalist(),i._init(),i._initValue(),i._chained(),s=i._keyword()}})},e("input.flexdatalist").flexdatalist()}(jQuery);