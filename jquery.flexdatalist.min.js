!function(e){e.fn.flexdatalist=function(t){if("value"===t){var i=e(this).next('input[type="hidden"]');return i.length>0?i.val():""}var a=e(document);return a.data("flexdatalist")||e(document).mouseup(function(t){var i=e(".flexdatalist-results");i.is(t.target)||0!==i.has(t.target).length||i.remove()}).keydown(function(t){var i=e(".flexdatalist-results"),a=i.find("li"),n=a.filter(".active"),r=n.index(),l=a.length,s=t.keyCode||t.which;if(0!==l)if(13===s)t.preventDefault(),n.click();else if(40===s||38===s){var o=0;40===s?l>r&&n.nextAll(".item").first().length>0&&(n=n.removeClass("active").nextAll(".item").first().addClass("active"),o=(0===n.prev().length?n:n.prev()).position().top,i.animate({scrollTop:o+i.scrollTop()},100)):38===s&&r>0&&n.prevAll(".item").first().length>0&&(n=n.removeClass("active").prevAll(".item").first().addClass("active"),o=(0===n.prev().length?n:n.prev()).position().top,i.animate({scrollTop:o+i.scrollTop()},100))}}).data("flexdatalist",!0),this.each(function(){var t=e(this),i={},a=t.attr("name");if(!t.hasClass("flexdatalist-set")){var n=e.extend({url:null,data:[],file:null,cache:!0,searchContain:!1,minLength:2,mergeRemoteData:!1,groupBy:!1,selectionRequired:!1,focusFirstResult:!0,valueProperty:"value",sendProperty:"value",visibleProperties:[],searchIn:["label"]},n,t.data());n.searchIn="string"==typeof n.searchIn?n.searchIn.split(","):n.searchIn,n.visibleProperties=0===n.visibleProperties.length?n.searchIn:n.visibleProperties,t.init=function(){t.on("input keyup",function(e){var i=e.keyCode||e.which;if(13!==i&&38!==i&&40!==i){var a=t.keyword();a.length>=n.minLength?t.search():t.removeResults(),n.selectionRequired||t.value(a)}}).blur(function(){n.selectionRequired&&!t.selected()&&t.val("").value("")}).attr("autocomplete","off").addClass("flexdatalist-set").trigger("init.flexdatalist",[n]),n.selectionRequired&&!t.selected()&&t.val("").value(""),window.onresize=function(){t.position()},t.datalist()},t.search=function(){t._data(function(i){var a=[],r=t.keyword();n.mergeRemoteData&&(i=e["extends"](n.data,i));for(var l=n.groupBy,s=0;s<i.length;s++){var o=t.match(i[s],r);if(o)if(l){if("undefined"!=typeof o[l]){var d=o[l];"undefined"==typeof a[d]&&(a[d]=[]),a[d].push(o)}}else a.push(o)}t.results(a)})},t.match=function(e,i){for(var a=!1,r=0;r<n.searchIn.length;r++){var l=n.searchIn[r];if("undefined"!=typeof e[l]){var s=e[l];t.find(s,i)&&(e[l+"_highlight"]=t.highlight(s,i),a=!0)}}return a?e:null},t.highlight=function(e,t){return e.replace(new RegExp(t,n.searchContain?"ig":"i"),'<span class="highlight">$&</span>')},t.find=function(e,i){return e=t.normalizeString(e),i=t.normalizeString(i),n.searchContain?e.indexOf(i)>=0:0===e.indexOf(i)},t._data=function(i){if(n.data.length>0)return void i(n.data);if(n.url||n.file){var a=t.keyword(),r=n.url?n.url:n.file,l=a.substring(0,n.minLength),s=t.cache(l);return s?void i(s):void(t.hasClass("flexdatalist-loading")||(t.addClass("flexdatalist-loading"),e.ajax({url:r,data:{keyword:l,contain:n.searchContain},type:"post",dataType:"json",success:function(e){t.removeClass("flexdatalist-loading");var a=e.results?e.results:e;"string"==typeof a&&0===a.indexOf("[{")&&(a=JSON.parse(a)),"object"==typeof a&&(i(a),n.url?t.cache(l,a):n.file&&(n.data=e))}})))}},t.datalist=function(){var i=t.attr("list");i&&(t.attr("list",null),e("#"+i).find("option").each(function(){var t=e(this).val();n.data.push({label:t,value:t})}))},t.cache=function(e,a){if(n.cache){if(e=t.normalizeString(e),"undefined"==typeof a)return"undefined"!=typeof i[e]&&(a=i[e]),a;i[e]=a}return null},t.results=function(i){if(t.removeResults(),0!==i.length||0!==Object.keys(i).length){var a=t.getContainer();t.selected()&&t.selected(!1).value(""),n.groupBy?Object.keys(i).forEach(function(r){var l=i[r],s=n.groupBy,o=t.getHighlight(l[0],s,r);e("<li>").addClass("group").append(e("<span>").addClass("group-name").html(o)).append(e("<span>").addClass("group-item-count").text(" "+l.length)).appendTo(a);t.items(l,a)}):t.items(i,a);var r=a.find("li:not(.group)");r.on("click",function(){var i=e(this).data("item");t.selected(!0).removeResults().value(i)}).hover(function(){r.removeClass("active"),e(this).addClass("active")},function(){e(this).removeClass("active")}),n.focusFirstResult&&r.filter(":first").addClass("active"),t.position()}},t.getContainer=function(){var i=e("ul.flexdatalist-results");return 0===i.length&&(i=e("<ul>").addClass("flexdatalist-results").appendTo("body").css({"border-color":t.css("border-left-color"),"border-width":t.css("border-left-width")})),i},t.removeResults=function(){return e("ul.flexdatalist-results").remove(),t},t.items=function(e,i){for(var a=0;a<e.length;a++)t.item(e[a]).appendTo(i)},t.item=function(i){for(var a=e("<li>").data("item",i).addClass("item"),r=0;r<n.visibleProperties.length;r++){var l=n.visibleProperties[r];if(!(n.groupBy&&n.groupBy===l||"undefined"==typeof i[l])){var s={};if("thumb"===l)s=e("<img>").addClass("item-"+l).attr("src",i[l]);else{var o=t.getHighlight(i,l);s=e("<span>").addClass("item-"+l).html(o+" ")}s.appendTo(a)}}return a},t.hiddenInput=function(){var i=e('input[type="hidden"][name="'+a+'"]');return i.length>0?i:(t.attr("name",null),e('<input type="hidden">').attr({name:a}).insertAfter(t))},t.value=function(e){var i="",a=e;return"object"==typeof e&&(i=e[n.searchIn[0]],"undefined"!=typeof e[n.valueProperty]&&(i=e[n.valueProperty]),n.sendProperty?n.sendProperty===n.valueProperty?a=i:"undefined"!=typeof e[n.sendProperty]&&(a=e[n.sendProperty]):a=JSON.stringify(e),t.trigger("select.flexdatalist",[a,i]).val(i)),i=i.trim(),t.data("value",a).hiddenInput().val(a),t},t.normalizeString=function(e){return e.toUpperCase()},t.selected=function(e){var i="flexdatalist-selected";return"undefined"==typeof e?t.hasClass(i):(e?t.addClass(i):t.removeClass(i),t)},t.keyword=function(){return this.val().replace(/^\s+/,"")},t.getHighlight=function(e,t,i){return"undefined"!=typeof e[t+"_highlight"]?e[t+"_highlight"]:"undefined"!==e[t]?e[t]:i},t.position=function(){e("ul.flexdatalist-results").css({width:t.outerWidth()+"px",top:t.offset().top+t.outerHeight()+"px",left:t.offset().left+"px","z-index":t.css("z-index")+1})},t.init()}})},e(".flexdatalist").flexdatalist()}(jQuery);